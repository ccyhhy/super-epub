name: Release Obsidian plugin

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm install


      - name: Build
        run: npm run build

      # 把产物整理到 release/ 目录，避免路径不一致导致上传失败
      - name: Prepare release assets
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release

          # 必须有 manifest.json
          if [ ! -f manifest.json ]; then
            echo "ERROR: manifest.json not found in repo root"
            exit 1
          fi
          cp manifest.json release/manifest.json

          # styles.css 可选（有就带上）
          if [ -f styles.css ]; then
            cp styles.css release/styles.css
          else
            echo "INFO: styles.css not found, skip"
          fi

          # main.js 必须有：优先根目录，其次 dist/
          if [ -f main.js ]; then
            cp main.js release/main.js
          elif [ -f dist/main.js ]; then
            cp dist/main.js release/main.js
          else
            echo "ERROR: main.js not found (expected main.js or dist/main.js)"
            ls -la
            echo "dist list:"
            ls -la dist || true
            exit 1
          fi

          # 额外：把整个 release 目录打包成 zip（很多人喜欢同时提供 zip）
          cd release
          zip -r ../release.zip .

      - name: Create GitHub Release & upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/main.js
            release/manifest.json
            release/styles.css
            release.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
